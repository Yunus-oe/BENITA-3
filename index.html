import React, { useState, useEffect } from "react";

// T√ºrkisch-Lernplattform ‚Äî Portal (Tanzen) & Student (Benita)
// - Vereinfachter L√ºckentext-Editor: Klick ein Wort im Editor, es wird als nummerierte L√ºcke eingef√ºgt.
// - Studentenseite: L√ºckentext als Drag & Drop ‚Äî Wortchips ziehen in L√ºcken.
// - Historie zeigt nur ver√∂ffentlichte (historische) Einheiten.

export default function TurkishLearner() {
  const UNITS_KEY = "tl_units_v2_dragdrop";

  const [units, setUnits] = useState(() => {
    try { return JSON.parse(localStorage.getItem(UNITS_KEY)) || []; } catch { return []; }
  });

  const [nameInput, setNameInput] = useState("");
  const [gate, setGate] = useState("lock"); // lock | portal | student
  const [message, setMessage] = useState("");

  // editor
  const [editorUnitName, setEditorUnitName] = useState("Einheit 1");
  const [editorWords, setEditorWords] = useState([]);
  const [editorTurkish, setEditorTurkish] = useState("");
  const [editorGerman, setEditorGerman] = useState("");
  const [editorLueckentext, setEditorLueckentext] = useState("");
  const [editorBlanks, setEditorBlanks] = useState({}); // {1: 'merhaba'}

  // student
  const [currentUnitId, setCurrentUnitId] = useState(null);
  const [placements, setPlacements] = useState({});
  const [celebrate, setCelebrate] = useState(false);

  useEffect(() => { localStorage.setItem(UNITS_KEY, JSON.stringify(units)); }, [units]);

  function shuffle(a) { return a.slice().sort(() => Math.random() - 0.5); }
  function nextBlankIndex(map) { const keys = Object.keys(map).map(Number); return keys.length ? Math.max(...keys)+1 : 1; }

  function submitName(e){ e && e.preventDefault(); const name = (nameInput||"").trim(); if(!name){ setMessage('Bitte Namen eingeben.'); return; } const lower = name.toLowerCase();
    if(lower === 'tanzen'){ setGate('portal'); setMessage(''); const draft = units.find(u=>!u.published); if(draft){ setEditorUnitName(draft.name||'Einheit-Entwurf'); setEditorWords(draft.words||[]); setEditorLueckentext(draft.lueckentext||''); setEditorBlanks(draft.blanks||{}); } else { setEditorUnitName('Einheit 1'); setEditorWords([]); setEditorLueckentext(''); setEditorBlanks({}); } return; }
    if(lower === 'benita'){ setGate('student'); setMessage(''); const published = units.filter(u=>u.published).sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt)); if(published.length) setCurrentUnitId(published[0].id); return; }
    setMessage(`\"${name}\" stimmt nicht ‚Äî versuch's nochmal. Tipp: \"Tanzen\" √∂ffnet das geheime Editor-Portal.`);
  }

  function logout(){ setNameInput(''); setGate('lock'); setMessage(''); setCurrentUnitId(null); setCelebrate(false); setPlacements({}); }

  // editor functions
  function editorAddWord(){ const t = (editorTurkish||'').trim(); const g = (editorGerman||'').trim(); if(!t||!g) return; setEditorWords(w=>[...w,{t,g}]); setEditorTurkish(''); setEditorGerman(''); }
  function editorRemoveWord(i){ setEditorWords(w=>w.filter((_,idx)=>idx!==i)); }

  // click word -> append numbered blank to text and map
  function editorInsertBlankFromWord(word){ const idx = nextBlankIndex(editorBlanks); const token = `__[${idx}]__`; setEditorLueckentext(s => (s ? s + ' ' + token : token)); setEditorBlanks(b => ({ ...b, [idx]: word })); }

  function editorParseCustomToBlanks(){ const regex = /{{\s*([^}]+?)\s*}}/g; let m; let i = nextBlankIndex(editorBlanks); let newText = editorLueckentext; const map = { ...editorBlanks }; while((m = regex.exec(editorLueckentext)) !== null){ map[i] = m[1]; newText = newText.replace(m[0], `__[${i}]__`); i++; } setEditorLueckentext(newText); setEditorBlanks(map); }

  function editorSaveDraft(){ const draft = { id:`u-${Date.now()}`, name: editorUnitName||'Einheit-Entwurf', words: editorWords, lueckentext: editorLueckentext, blanks: editorBlanks, published:false, createdAt: new Date().toISOString(), completedAt: null }; setUnits(prev => { const others = prev.filter(u=>u.published); return [draft, ...others]; }); alert('Entwurf gespeichert.'); }

  function editorPublishUnit(){ if(editorWords.length===0) return alert('Bitte W√∂rter hinzuf√ºgen.'); const unit = { id:`u-${Date.now()}`, name: editorUnitName||'Einheit', words: editorWords, lueckentext: editorLueckentext, blanks: editorBlanks, published:true, createdAt: new Date().toISOString(), completedAt: null }; setUnits(prev => [unit, ...prev.filter(u=>u.published)]); alert('Einheit ver√∂ffentlicht ‚Äî erscheint nun f√ºr Benita.'); }

  // student functions (drag-drop)
  function onDragStart(ev, word){ ev.dataTransfer.setData('text/plain', word); }
  function onDropBlank(ev, blankId){ ev.preventDefault(); const word = ev.dataTransfer.getData('text/plain'); if(!word) return; setPlacements(p => ({ ...p, [blankId]: word })); }
  function onAllowDrop(ev){ ev.preventDefault(); }

  function studentCheck(){ const unit = units.find(u=>u.id===currentUnitId) || units.filter(u=>u.published)[0]; if(!unit) return; const blanksMap = unit.blanks||{}; let correct = 0; const total = Object.keys(blanksMap).length; for(const k of Object.keys(blanksMap)){ const expected = (blanksMap[k]||'').trim().toLowerCase(); const got = (placements[k]||'').trim().toLowerCase(); if(expected === got) correct++; } if(correct === total && total>0){ setCelebrate(true); setUnits(prev => prev.map(u=>u.id===unit.id ? { ...u, completedAt: new Date().toISOString() } : u)); alert('Super! Einheit geschafft üéâ'); } else { alert(`Du hast ${correct} von ${total} richtig. Versuch's nochmal.`); } }

  // auto-generate helper (simple)
  function editorAutoGenerateLueckentext(){ if(editorWords.length===0) return alert('Keine W√∂rter im Editor.'); const words = editorWords.map(x=>x.t); const phrases = ['Heute denke ich an','Im Park h√∂re ich','Abends sitze ich bei','Am Morgen rieche ich']; const pick = Math.min(4, words.length); const picked = shuffle(words).slice(0,pick); const sentences = picked.map((w,i)=> `${phrases[i%phrases.length]} ${w}.`); let text = sentences.join(' '); const mapping = {}; picked.forEach((w,i)=>{ const token = `__[${i+1}]__`; text = text.replace(w, token); mapping[i+1] = w; }); setEditorLueckentext(text); setEditorBlanks(mapping); }

  // UI
  if(gate === 'lock'){
    return (
      <div style={{ maxWidth:900, margin:'24px auto', padding:10 }}>
        <div style={{ background:'#fff', padding:18, borderRadius:10 }}>
          <h1>T√ºrkisch ‚Äî Zugang</h1>
          <form onSubmit={submitName} style={{ marginTop:12 }}>
            <input placeholder="Deinen Namen (Benita oder Tanzen)" value={nameInput} onChange={e=>setNameInput(e.target.value)} style={{ width:'100%', padding:8 }} />
            <div style={{ marginTop:10, display:'flex', gap:8 }}>
              <button className="btnPrimary" type="submit">Weiter</button>
              <button type="button" onClick={()=>{ setNameInput('Benita'); submitName({preventDefault: ()=>{}}); }}>Demo Benita</button>
            </div>
            {message && <div style={{ color:'#9b1c1c', marginTop:10 }}>{message}</div>}
            <p style={{ color:'#666', marginTop:8 }}>Editor-Portal ist geheim ‚Äî nur √ºber den Namen "Tanzen" erreichbar.</p>
          </form>
        </div>
      </div>
    );
  }

  if(gate === 'portal'){
    return (
      <div style={{ maxWidth:1000, margin:'18px auto' }}>
        <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
          <h1>Portal ‚Äî Einheiten erstellen (geheim)</h1>
          <div style={{ display:'flex', gap:8 }}><button onClick={logout}>Logout</button></div>
        </div>

        <div style={{ background:'#fff', padding:16, borderRadius:10, marginTop:12 }}>
          <label>Einheitsname</label>
          <input value={editorUnitName} onChange={e=>setEditorUnitName(e.target.value)} style={{ width:'100%', padding:8, marginTop:6 }} />

          <h3 style={{ marginTop:12 }}>W√∂rter</h3>
          <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:8 }}>
            <input placeholder='T√ºrkisch' value={editorTurkish} onChange={e=>setEditorTurkish(e.target.value)} />
            <input placeholder='Deutsch' value={editorGerman} onChange={e=>setEditorGerman(e.target.value)} />
          </div>
          <div style={{ marginTop:8, display:'flex', gap:8 }}>
            <button onClick={editorAddWord}>Hinzuf√ºgen</button>
            <button onClick={()=>setEditorWords([])}>Alle l√∂schen</button>
            <button onClick={editorAutoGenerateLueckentext}>L√ºckentext auto</button>
            <button onClick={editorParseCustomToBlanks}>Text -> L√ºcken</button>
          </div>

          <div style={{ marginTop:12 }}>
            <h4>Aktuelle W√∂rter ({editorWords.length}) ‚Äî klicke ein Wort, um eine L√ºcke einzuf√ºgen</h4>
            <ul style={{ paddingLeft:18 }}>
              {editorWords.map((w,i)=>(
                <li key={i} style={{ marginBottom:6 }}>{w.t} ‚Äî {w.g} <button style={{ marginLeft:8 }} onClick={()=>editorInsertBlankFromWord(w.t)}>Als L√ºcke einf√ºgen</button></li>
              ))}
            </ul>
          </div>

          <div style={{ marginTop:12 }}>
            <h4>L√ºckentext (Vorschau)</h4>
            <textarea value={editorLueckentext} onChange={e=>setEditorLueckentext(e.target.value)} style={{ width:'100%', minHeight:100 }} />
            <div style={{ marginTop:8, display:'flex', gap:8 }}>
              <button onClick={editorSaveDraft}>Entwurf speichern</button>
              <button onClick={()=>{ if(!editorWords.length) return alert('Keine W√∂rter'); if(!editorLueckentext) return alert('Kein L√ºckentext'); editorPublishUnit(); }}>Als Einheit ver√∂ffentlichen</button>
            </div>
          </div>

          <div style={{ marginTop:18 }}>
            <h4>Ver√∂ffentlichte Einheiten (historisch)</h4>
            {units.filter(u=>u.published).length===0 && <div style={{ color:'#666' }}>Keine ver√∂ffentlichten Einheiten.</div>}
            {units.filter(u=>u.published).map(u=> (
              <div key={u.id} style={{ padding:8, border:'1px solid #eee', borderRadius:6, marginTop:8 }}>
                <div style={{ display:'flex', justifyContent:'space-between' }}><strong>{u.name}</strong> <span style={{ color:'#666' }}>{new Date(u.createdAt).toLocaleString()}</span></div>
                <div style={{ marginTop:6 }}>W√∂rter: {u.words.length} ‚Äî {u.lueckentext ? 'L√ºckentext vorhanden' : 'kein L√ºckentext'}</div>
                {u.completedAt && <div style={{ marginTop:6, color:'#0b9f6b' }}>Abgeschlossen: {new Date(u.completedAt).toLocaleString()}</div>}
              </div>
            ))}
          </div>

        </div>
      </div>
    );
  }

  if(gate === 'student'){
    const published = units.filter(u=>u.published).sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
    const unit = published.find(u=>u.id===currentUnitId) || published[0] || null;

    return (
      <div style={{ maxWidth:900, margin:'18px auto' }}>
        <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
          <h1>Hallo Benita ‚Äî deine heutige Einheit</h1>
          <div style={{ display:'flex', gap:8 }}><button onClick={logout}>Logout</button><button onClick={()=>{ const p = units.filter(u=>u.published); if(p.length) setCurrentUnitId(p[0].id); }}>Neu laden</button></div>
        </div>

        {!unit && <div style={{ marginTop:12, padding:12, background:'#fff', borderRadius:8 }}>Es ist noch keine Einheit ver√∂ffentlicht. Bitte frag "Tanzen" danach ‚ù§Ô∏è</div>}

        {unit && (
          <div style={{ marginTop:12, background:'#fff', padding:16, borderRadius:10 }}>
            <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
              <div><h2 style={{ margin:0 }}>{unit.name}</h2><div style={{ color:'#666' }}>{new Date(unit.createdAt).toLocaleString()}</div></div>
              <div style={{ textAlign:'right' }}>{unit.completedAt ? <div style={{ color:'#0b9f6b' }}>Schon abgeschlossen: {new Date(unit.completedAt).toLocaleString()}</div> : <div style={{ color:'#666' }}>Noch nicht abgeschlossen</div>}</div>
            </div>

            <div style={{ marginTop:12 }}>
              <h4>W√∂rter (heute)</h4>
              <ul>{unit.words.map((w,i)=>(<li key={i}>{w.t} ‚Äî {w.g}</li>))}</ul>
            </div>

            <div style={{ marginTop:12 }}>
              <h4>L√ºckentext ‚Äî zieh die W√∂rter in die L√ºcken</h4>

              {unit.lueckentext ? (
                <div>
                  <div style={{ padding:12, border:'1px dashed #dbeafe', borderRadius:8 }}>
                    {unit.lueckentext.split(/(__\\[\\d+\\]__)/g).filter(Boolean).map((pc, idx) => {
                      const m = pc.match(/__\\[(\\d+)\\]__/);
                      if (m) {
                        const id = m[1];
                        return (
                          <span key={idx} onDrop={(e)=>onDropBlank(e,id)} onDragOver={onAllowDrop} style={{ display:'inline-block', minWidth:120, padding:6, marginRight:6, marginBottom:6, border:'1px solid #ccc', borderRadius:6, background:'#fff' }}>
                            {placements[id] ? <strong>{placements[id]}</strong> : <em style={{ color:'#888' }}>[Zieh hier '{id}']</em>}
                          </span>
                        );
                      }
                      return <span key={idx} style={{ marginRight:6 }}>{pc}</span>;
                    })}
                  </div>

                  <div style={{ marginTop:12 }}>
                    <h5>W√§hle die W√∂rter aus und ziehe sie in die L√ºcken</h5>
                    <div style={{ display:'flex', gap:8, flexWrap:'wrap' }}>
                      {shuffle(unit.words.map(w=>w.t)).map((word, i) => (
                        <div key={i} draggable onDragStart={(e)=>onDragStart(e,word)} style={{ padding:'6px 10px', borderRadius:20, background:'#eef2ff', cursor:'grab' }}>{word}</div>
                      ))}
                    </div>
                  </div>

                  <div style={{ marginTop:12, display:'flex', gap:8 }}>
                    <button className='btnPrimary' onClick={studentCheck}>Absenden</button>
                    <button onClick={()=>setPlacements({})}>Zur√ºcksetzen</button>
                  </div>

                </div>
              ) : (
                <div style={{ color:'#666' }}>Kein L√ºckentext f√ºr diese Einheit vorhanden.</div>
              )}

            </div>

            {celebrate && (
              <div style={{ marginTop:14, padding:12, borderRadius:8, background:'#fff7ed', border:'1px solid #ffecd1' }}>
                <h3 style={{ margin:0 }}>üéâ Gut gemacht, Benita!</h3>
                <p style={{ marginTop:6 }}>Du hast die heutige Einheit abgeschlossen ‚Äî gro√üartig. üòò</p>
              </div>
            )}

          </div>
        )}

        <div style={{ marginTop:12 }}>
          <h4>Historische Einheiten (ver√∂ffentlichte)</h4>
          {units.filter(u=>u.published).length===0 && <div style={{ color:'#666' }}>Keine historischen Einheiten vorhanden.</div>}
          {units.filter(u=>u.published).map(u=> (
            <div key={u.id} style={{ padding:8, border:'1px solid #eee', borderRadius:6, marginTop:8 }}>
              <div style={{ display:'flex', justifyContent:'space-between' }}><strong>{u.name}</strong> <span style={{ color:'#666' }}>{new Date(u.createdAt).toLocaleString()}</span></div>
              <div style={{ marginTop:6 }}>W√∂rter: {u.words.length} ‚Äî {u.lueckentext ? 'L√ºckentext' : 'kein L√ºckentext'}</div>
              {u.completedAt && <div style={{ marginTop:6, color:'#0b9f6b' }}>Abgeschlossen: {new Date(u.completedAt).toLocaleString()}</div>}
            </div>
          ))}
        </div>

      </div>
    );
  }

  return null;
}
