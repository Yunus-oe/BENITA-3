import React, { useState, useEffect } from "react";

// Türkisch-Lernplattform — Single-file React (Portal hidden behind "Tanzen")
// - Secret editor (Tanzen) to prepare a unit: add words, create Lückentext, publish unit.
// - Student (Benita) sees only the latest published unit (today's unit) with words + Lückentext.
// - Save units and history to localStorage. When Benita completes the Lückentext correctly, show a celebration and mark the unit completed.

export default function TurkishLearner() {
  const UNITS_KEY = "tl_units_v1";
  const HISTORY_KEY = "tl_history_v1";

  const [units, setUnits] = useState(() => {
    try { return JSON.parse(localStorage.getItem(UNITS_KEY)) || []; } catch { return []; }
  });
  const [history, setHistory] = useState(() => {
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch { return []; }
  });

  const [nameInput, setNameInput] = useState("");
  const [gate, setGate] = useState("lock"); // 'lock' | 'student' | 'portal'
  const [message, setMessage] = useState("");

  // Portal editor state
  const [editorUnitName, setEditorUnitName] = useState("Einheit 1");
  const [editorWords, setEditorWords] = useState([]); // [{t,g}]
  const [editorTurkish, setEditorTurkish] = useState("");
  const [editorGerman, setEditorGerman] = useState("");
  const [editorLueckentext, setEditorLueckentext] = useState("");
  const [editorBlanks, setEditorBlanks] = useState({});

  // Student state
  const [currentUnitId, setCurrentUnitId] = useState(null);
  const [lueckentextUser, setLueckentextUser] = useState({});
  const [celebrate, setCelebrate] = useState(false);

  useEffect(() => { localStorage.setItem(UNITS_KEY, JSON.stringify(units)); }, [units]);
  useEffect(() => { localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); }, [history]);

  function addHistory(type, detail = {}) {
    const entry = { id: `${Date.now()}-${Math.random().toString(36).slice(2,6)}`, type, detail, time: new Date().toISOString() };
    setHistory(h => [entry, ...h].slice(0,200));
  }

  // Login gate
  function submitName(e) {
    e && e.preventDefault();
    const name = (nameInput || "").trim();
    if (!name) { setMessage("Bitte Namen eingeben."); return; }
    const lower = name.toLowerCase();
    if (lower === "benita") {
      setGate("student"); setMessage("");
      const published = units.filter(u => u.published).sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      if (published.length) setCurrentUnitId(published[0].id);
      addHistory('login', { name: 'Benita' });
    } else if (lower === "tanzen") {
      setGate("portal"); setMessage(""); addHistory('login', { name: 'Tanzen (portal)' });
      const draft = units.find(u => !u.published) || null;
      if (draft) {
        setEditorUnitName(draft.name || 'Einheit-Entwurf');
        setEditorWords(draft.words || []);
        setEditorLueckentext(draft.lueckentext || '');
        setEditorBlanks(draft.blanks || {});
      } else {
        setEditorUnitName('Einheit 1'); setEditorWords([]); setEditorLueckentext(''); setEditorBlanks({});
      }
    } else {
      setMessage(`"${name}" stimmt nicht — probier's nochmal. Tipp: gib 'Tanzen' ein, wenn du das Editor-Portal suchst.`);
    }
  }

  function logout() { setNameInput(""); setGate('lock'); setMessage(''); setCurrentUnitId(null); setCelebrate(false); setLueckentextUser({}); }

  // Portal actions
  function editorAddWord() {
    const t = (editorTurkish||'').trim(); const g = (editorGerman||'').trim(); if (!t||!g) return;
    setEditorWords(w => [...w, { t,g }]); setEditorTurkish(''); setEditorGerman('');
  }
  function editorRemoveWord(i){ setEditorWords(w => w.filter((_,idx)=>idx!==i)); }
  function editorAutoGenerateLueckentext(){
    if (editorWords.length === 0) return alert('Keine Wörter im Editor.');
    const words = editorWords.map(x=>x.t);
    const phrases = ['Heute denke ich an','Im Park höre ich','Abends sitze ich bei','Am Morgen rieche ich'];
    const pick = Math.min(4, words.length);
    const picked = shuffle(words).slice(0,pick);
    const sentences = picked.map((w,i)=>`${phrases[i%phrases.length]} ${w}.`);
    let text = sentences.join(' ');
    const mapping = {};
    picked.forEach((w,i)=>{ const token = `__[${i+1}]__`; text = text.replace(w, token); mapping[i+1]=w; });
    setEditorLueckentext(text); setEditorBlanks(mapping);
  }
  function editorParseCustomToBlanks(){
    const regex = /{{\s*([^}]+?)\s*}}/g; let m; let i=1; let newText = editorLueckentext; const map = {};
    while((m = regex.exec(editorLueckentext)) !== null){ map[i]=m[1]; newText = newText.replace(m[0], `__[${i}]__`); i++; }
    if(Object.keys(map).length===0) return alert('Keine {{...}} gefunden.');
    setEditorLueckentext(newText); setEditorBlanks(map);
  }
  function editorSaveDraft(){
    const draft = { id: `u-${Date.now()}`, name: editorUnitName||'Einheit-Entwurf', words: editorWords, lueckentext: editorLueckentext, blanks: editorBlanks, published:false, createdAt: new Date().toISOString(), completedAt: null };
    setUnits(prev => { addHistory('unit:draft_save',{id:draft.id,name:draft.name,words:draft.words.length}); return [draft, ...prev.filter(u=>u.published)]; });
    alert('Entwurf gespeichert.');
  }
  function editorPublishUnit(){
    if(editorWords.length===0) return alert('Bitte Wörter hinzufügen.');
    const unit = { id: `u-${Date.now()}`, name: editorUnitName||'Einheit', words: editorWords, lueckentext: editorLueckentext, blanks: editorBlanks, published:true, createdAt: new Date().toISOString(), completedAt: null };
    setUnits(prev => { addHistory('unit:publish',{id:unit.id,name:unit.name,words:unit.words.length}); return [unit, ...prev.filter(u=>u.published)]; });
    alert('Einheit veröffentlicht — erscheint nun für Benita.');
  }

  // Student actions
  function studentSelectUnit(id){ setCurrentUnitId(id); setLueckentextUser({}); setCelebrate(false); }
  function studentCheckLueckentext(){
    const u = units.find(x=>x.id===currentUnitId) || units.filter(x=>x.published)[0]; if(!u) return;
    const blanksMap = u.blanks||{}; let correct=0; const total = Object.keys(blanksMap).length;
    for(const k of Object.keys(blanksMap)){ const expected=(blanksMap[k]||'').toLowerCase(); const got=(lueckentextUser[k]||'').trim().toLowerCase(); if(expected===got) correct++; }
    addHistory('student:lueckentext_check',{unitId:u.id,correct,total});
    if(correct===total){ setCelebrate(true); setUnits(prev => prev.map(p => p.id===u.id ? {...p, completedAt:new Date().toISOString()} : p)); addHistory('student:unit_completed',{unitId:u.id}); }
    else alert(`Du hast ${correct} von ${total} richtig. Versuch's nochmal!`);
  }

  function shuffle(arr){ return arr.slice().sort(()=>Math.random()-0.5); }

  // Render: gate
  if (gate === 'lock'){
    return (
      <div style={{maxWidth:900,margin:'24px auto',padding:18}}>
        <div style={{padding:18,background:'#fff',borderRadius:10}}>
          <h1>Türkisch — Zugang</h1>
          <form onSubmit={submitName} style={{marginTop:12}}>
            <input placeholder="Name (Benita oder Tanzen)" value={nameInput} onChange={e=>setNameInput(e.target.value)} style={{width:'100%',padding:8,borderRadius:6,border:'1px solid #ddd'}} />
            <div style={{marginTop:10,display:'flex',gap:8}}>
              <button className='btnPrimary' type='submit'>Weiter</button>
              <button type='button' onClick={()=>{ setNameInput('Benita'); submitName({preventDefault: ()=>{}}); }}>Demo Benita</button>
            </div>
            {message && <div style={{marginTop:12,color:'#9b1c1c'}}>{message}</div>}
            <p style={{marginTop:10,color:'#666'}}>Editor-Portal ist geheim — zugänglich über den Namen "Tanzen".</p>
          </form>
        </div>
      </div>
    );
  }

  // Portal (Tanzen) — hidden editor
  if (gate === 'portal'){
    return (
      <div style={{maxWidth:1000,margin:'18px auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <h1>Portal — Einheiten erstellen (geheim)</h1>
          <div style={{display:'flex',gap:8}}><button onClick={logout}>Logout</button></div>
        </div>
        <div style={{marginTop:12,padding:16,background:'#fff',borderRadius:10}}>
          <label>Einheitsname</label>
          <input value={editorUnitName} onChange={e=>setEditorUnitName(e.target.value)} style={{width:'100%',padding:8,borderRadius:6,border:'1px solid #ddd'}} />
          <h3 style={{marginTop:12}}>Wörter</h3>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
            <input placeholder='Türkisch' value={editorTurkish} onChange={e=>setEditorTurkish(e.target.value)} />
            <input placeholder='Deutsch' value={editorGerman} onChange={e=>setEditorGerman(e.target.value)} />
          </div>
          <div style={{marginTop:8,display:'flex',gap:8}}>
            <button onClick={editorAddWord}>Hinzufügen</button>
            <button onClick={()=>setEditorWords([])}>Alle löschen</button>
            <button onClick={editorAutoGenerateLueckentext}>Lückentext auto</button>
            <button onClick={editorParseCustomToBlanks}>Text -> Lücken</button>
          </div>

          <div style={{marginTop:12}}>
            <h4>Aktuelle Wörter ({editorWords.length})</h4>
            <ul style={{padding:0}}>{editorWords.map((w,i)=>(<li key={i} style={{listStyle:'none',padding:6,borderBottom:'1px solid #eee',display:'flex',justifyContent:'space-between'}}>{w.t} — {w.g} <button onClick={()=>editorRemoveWord(i)}>Löschen</button></li>))}</ul>
          </div>

          <div style={{marginTop:12}}>
            <h4>Lückentext-Vorschau</h4>
            <textarea value={editorLueckentext} onChange={e=>setEditorLueckentext(e.target.value)} style={{width:'100%',minHeight:80}} />
            <div style={{marginTop:8,display:'flex',gap:8}}>
              <button onClick={editorSaveDraft}>Entwurf speichern</button>
              <button onClick={()=>{ if(!editorWords.length) return alert('Keine Wörter'); if(!editorLueckentext) return alert('Kein Lückentext'); editorPublishUnit(); }}>Als Einheit veröffentlichen</button>
            </div>
          </div>

          <div style={{marginTop:18}}>
            <h4>Veröffentlichte Einheiten</h4>
            {units.filter(u=>u.published).length===0 && <div style={{color:'#666'}}>Keine veröffentlichten Einheiten.</div>}
            {units.filter(u=>u.published).map(u=>(<div key={u.id} style={{padding:8,border:'1px solid #eee',borderRadius:6,marginTop:8}}><div style={{display:'flex',justifyContent:'space-between'}}><strong>{u.name}</strong><span style={{color:'#666'}}>{new Date(u.createdAt).toLocaleString()}</span></div><div style={{marginTop:6}}>Wörter: {u.words.length} — {u.lueckentext ? 'Lückentext vorhanden' : 'kein Lückentext'}</div></div>))}
          </div>
        </div>
      </div>
    );
  }

  // Student (Benita) — show latest published unit only
  if (gate === 'student'){
    const published = units.filter(u=>u.published).sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
    const unit = published.find(u=>u.id===currentUnitId) || published[0] || null;
    return (
      <div style={{maxWidth:900,margin:'18px auto'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <h1>Hallo Benita — deine heutige Einheit</h1>
          <div style={{display:'flex',gap:8}}><button onClick={logout}>Logout</button><button onClick={()=>{ const p=units.filter(u=>u.published); if(p.length) setCurrentUnitId(p[0].id); }}>Neu laden</button></div>
        </div>
        {!unit && <div style={{marginTop:12,padding:12,background:'#fff',borderRadius:8}}>Es ist noch keine Einheit veröffentlicht. Bitte frag "Tanzen" danach ❤️</div>}
        {unit && (
          <div style={{marginTop:12,background:'#fff',padding:16,borderRadius:10}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <div><h2 style={{margin:0}}>{unit.name}</h2><div style={{color:'#666'}}>{new Date(unit.createdAt).toLocaleString()}</div></div>
              <div style={{textAlign:'right'}}>{unit.completedAt ? <div style={{color:'#0b9f6b'}}>Schon abgeschlossen: {new Date(unit.completedAt).toLocaleString()}</div> : <div style={{color:'#666'}}>Noch nicht abgeschlossen</div>}</div>
            </div>
            <div style={{marginTop:12}}>
              <h4>Wörter (heute)</h4>
              <ul>{unit.words.map((w,i)=>(<li key={i}>{w.t} — {w.g}</li>))}</ul>
            </div>
            <div style={{marginTop:12}}>
              <h4>Lückentext</h4>
              {unit.lueckentext ? (
                <div>{unit.lueckentext.split(/(__\[\d+\]__)/g).filter(Boolean).map((pc,idx)=>{ const m = pc.match(/__\[(\d+)\]__/); if(m){ const id=m[1]; return <input key={idx} placeholder={`[${id}]`} value={lueckentextUser[id]||''} onChange={(e)=>setLueckentextUser(u=>({...u,[id]:e.target.value}))} style={{marginRight:6,marginBottom:6}} /> } return <span key={idx} style={{marginRight:6}}>{pc}</span> })}<div style={{marginTop:8}}><button className='btnPrimary' onClick={studentCheckLueckentext}>Absenden</button></div></div>
              ) : <div style={{color:'#666'}}>Kein Lückentext für diese Einheit vorhanden.</div>}
            </div>
            {celebrate && (<div style={{marginTop:14,padding:12,borderRadius:8,background:'#fff7ed',border:'1px solid #ffecd1'}}><h3 style={{margin:0}}>🎉 Gut gemacht, Benita!</h3><p style={{marginTop:6}}>Du hast die heutige Einheit abgeschlossen — großartig. Ein Küsschen: 😘</p></div>)}
          </div>
        )}
        <div style={{marginTop:12}}>
          <h4>Historie</h4>
          {history.length===0 && <div style={{color:'#666'}}>Keine Aktionen gespeichert.</div>}
          {history.slice(0,10).map(h=>(<div key={h.id} style={{padding:8,border:'1px solid #eee',borderRadius:6,marginTop:8}}><div><strong>{h.type}</strong> <span style={{color:'#666'}}>— {new Date(h.time).toLocaleString()}</span></div><pre style={{whiteSpace:'pre-wrap',margin:6}}>{JSON.stringify(h.detail)}</pre></div>))}
        </div>
      </div>
    );
  }

  return null;
}
